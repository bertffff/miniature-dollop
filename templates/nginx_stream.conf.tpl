# Marzban Ultimate VPN - Stream Configuration (SNI Routing)
# Generated by installer - Do not edit manually
#
# Traffic Flow:
# Port 443 -> SNI Inspection -> Route to appropriate backend
#   - Reality SNI -> Xray (port ${XRAY_PORT})
#   - Panel domain -> Marzban HTTPS (port ${MARZBAN_PORT})
#   - Other/Invalid -> Fake website (port 8080)

# Map SNI to upstream backend
map $ssl_preread_server_name $backend_name {
    # Route Reality connections to Xray
    # These domains are used for Reality protocol camouflage
    ${REALITY_SERVER_NAMES_MAP}
    
    # Route panel domain to Marzban (HTTPS termination)
    ${DOMAIN}    marzban_https;
    
    # Default: route to fake website
    default      fake_site;
}

# Upstream: Xray Reality backend
upstream xray_backend {
    server 127.0.0.1:${XRAY_PORT};
}

# Upstream: Marzban HTTPS backend (with SSL termination by Nginx)
upstream marzban_https {
    server 127.0.0.1:${MARZBAN_HTTPS_PORT};
}

# Upstream: Fake website backend
upstream fake_site {
    server 127.0.0.1:8080;
}

# Main listener on port 443
server {
    listen 443 reuseport;
    listen [::]:443 reuseport;
    
    # Enable SNI inspection without terminating SSL
    ssl_preread on;
    
    # Proxy settings
    proxy_pass $backend_name;
    proxy_protocol off;
    
    # Timeouts
    proxy_connect_timeout 10s;
    proxy_timeout 300s;
    
    # Buffer sizes
    proxy_buffer_size 16k;
}

# Alternative: Direct Xray listener (optional, for non-SNI routing)
# Uncomment if you want a dedicated port for Reality
# server {
#     listen ${XRAY_ALT_PORT};
#     listen [::]:${XRAY_ALT_PORT};
#     
#     proxy_pass xray_backend;
#     proxy_protocol off;
# }
